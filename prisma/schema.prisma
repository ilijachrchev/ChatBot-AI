generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  fullname           String
  clerkId            String              @unique
  type               String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  lastNameChange     DateTime?
  avatar             String?
  stripeId           String?
  stripeCustomerId   String?
  keepMeLoggedIn     Boolean             @default(false)
  billingAddress     BillingAddress?
  subscription       Billings?
  campaign           Campaign[]
  domains            Domain[]
  knowledgeBaseFiles KnowledgeBaseFile[]
  knowledgeBaseChunks KnowledgeBaseChunk[]
  loginAttempts      LoginAttempt[]
  otpCodes           OtpCode[]
  paymentHistory     PaymentHistory[]
  pendingLogins      PendingLogin[]
  trustedDevices     TrustedDevice[]
  preferences        UserPreferences?
}

model Domain {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String
  icon               String
  verificationToken  String              @default(dbgenerated("gen_random_uuid()"))
  verificationStatus VerificationStatus  @default(PENDING)
  verificationMethod String?
  lastVerifiedAt     DateTime?
  verifiedAt         DateTime?
  userId             String?             @db.Uuid
  campaignId         String?             @db.Uuid
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @default(now()) @updatedAt
  timezone           String              @default("UTC")
  chatBot            ChatBot?
  chatRooms          ChatRoom[]          @relation("DomainToChatRoooms")
  customer           Customer[]
  Campaign           Campaign?           @relation(fields: [campaignId], references: [id])
  User               User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  filterQuestions    FilterQuestions[]
  helpdesk           HelpDesk[]
  knowledgeBaseFiles KnowledgeBaseFile[]
  knowledgeBaseChunks KnowledgeBaseChunk[]
  products           Product[]
  workingHours       WorkingHours?

  @@index([userId])
  @@index([verificationStatus])
}

model ChatBot {
  id                   String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  welcomeMessage       String?
  icon                 String?
  background           String?
  textColor            String?
  helpdesk             Boolean @default(false)
  domainId             String? @unique @db.Uuid
  backgroundColor      String? @default("#3B82F6")
  persona              String  @default("SendWise-Agent")
  customPrompt         String?
  chatbotTitle         String? @default("SendWise-AI")
  chatbotSubtitle      String?
  userBubbleColor      String? @default("#3B82F6")
  botBubbleColor       String? @default("#F1F5F9")
  userTextColor        String? @default("#FFFFFF")
  botTextColor         String? @default("#1E293B")
  buttonStyle          String? @default("ROUNDED")
  bubbleStyle          String? @default("ROUNDED")
  showAvatars          Boolean @default(true)
  widgetSize           String? @default("MEDIUM")
  widgetStyle          String? @default("SOLID")
  presenceMode         String  @default("AUTO")
  offlineBehavior      String  @default("SHOW_HOURS_AND_EMAIL")
  offlineCustomMessage String?
  showPresenceBadge    Boolean @default(true)
  Domain               Domain? @relation(fields: [domainId], references: [id], onDelete: Cascade)
}

model Billings {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  plan                   Plans     @default(STANDARD)
  credits                Int       @default(10)
  userId                 String?   @unique @db.Uuid
  stripeSubscriptionId   String?   @unique
  stripeCurrentPeriodEnd DateTime?
  stripePriceId          String?
  stripeCustomerId       String?
  status                 String    @default("active")
  cancelAtPeriodEnd      Boolean   @default(false)
  canceledAt             DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  User                   User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model HelpDesk {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  question String
  answer   String
  domainId String? @db.Uuid
  Domain   Domain? @relation(fields: [domainId], references: [id], onDelete: Cascade)
}

model FilterQuestions {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  question String
  answered String?
  domainId String? @db.Uuid
  Domain   Domain? @relation(fields: [domainId], references: [id], onDelete: Cascade)
}

model CustomerResponses {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  question   String
  answered   String?
  customerId String   @db.Uuid
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model Customer {
  id        String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String?
  domainId  String?             @db.Uuid
  booking   Bookings[]
  chatRoom  ChatRoom[]
  Domain    Domain?             @relation(fields: [domainId], references: [id], onDelete: Cascade)
  questions CustomerResponses[]
}

model ChatRoom {
  id         String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  live       Boolean       @default(false)
  mailed     Boolean       @default(false)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  domainId   String?       @db.Uuid
  customerId String?       @db.Uuid
  message    ChatMessage[]
  Customer   Customer?     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  Domain     Domain?       @relation("DomainToChatRoooms", fields: [domainId], references: [id], onDelete: Cascade)
}

model ChatMessage {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  message    String
  role       Role?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  chatRoomId String?   @db.Uuid
  seen       Boolean   @default(false)
  ChatRoom   ChatRoom? @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
}

model Bookings {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  date       DateTime
  slot       String
  email      String
  customerId String?   @db.Uuid
  domainId   String?   @db.Uuid
  createdAt  DateTime  @default(now())
  Customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

model Campaign {
  id          String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  customers   String[]
  template    String?
  userId      String?        @db.Uuid
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @default(now()) @updatedAt
  scheduledAt DateTime?
  status      CampaignStatus @default(DRAFT)
  sentAt      DateTime?
  timezone    String?
  User        User?          @relation(fields: [userId], references: [id], onDelete: Cascade)
  domain      Domain[]
}

model Product {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  price     Int
  image     String
  createdAt DateTime @default(now())
  domainId  String?  @db.Uuid
  Domain    Domain?  @relation(fields: [domainId], references: [id], onDelete: Cascade)
}

model TrustedDevice {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String   @db.Uuid
  deviceId          String   @unique
  deviceFingerprint String?
  userAgent         String?
  browserName       String?
  browserVersion    String?
  osName            String?
  osVersion         String?
  deviceType        String?
  ipAddress         String?
  city              String?
  region            String?
  country           String?
  lastUsedAt        DateTime @default(now())
  createdAt         DateTime @default(now())
  expiresAt         DateTime
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deviceId])
}

model LoginAttempt {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String?  @db.Uuid
  email           String
  success         Boolean  @default(false)
  riskScore       Int      @default(0)
  ipAddress       String?
  city            String?
  region          String?
  country         String?
  userAgent       String?
  browserName     String?
  deviceType      String?
  deviceId        String?
  isTrustedDevice Boolean  @default(false)
  otpRequired     Boolean  @default(false)
  otpVerified     Boolean  @default(false)
  failureReason   String?
  createdAt       DateTime @default(now())
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([ipAddress])
  @@index([createdAt])
}

model PendingLogin {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String   @db.Uuid
  email          String
  clerkSessionId String?
  deviceId       String?
  ipAddress      String?
  userAgent      String?
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
}

model OtpCode {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String    @db.Uuid
  codeHash    String
  attempts    Int       @default(0)
  maxAttempts Int       @default(5)
  expiresAt   DateTime
  verifiedAt  DateTime?
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model UserPreferences {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId               String   @unique @db.Uuid
  language             String   @default("en")
  timezone             String   @default("UTC")
  dateFormat           String   @default("MM/DD/YYYY")
  timeFormat           String   @default("12h")
  emailNotifications   Boolean  @default(true)
  desktopNotifications Boolean  @default(true)
  soundEnabled         Boolean  @default(true)
  defaultView          String   @default("conversations")
  conversationSort     String   @default("newest")
  itemsPerPage         Int      @default(25)
  workingHoursEnabled  Boolean  @default(false)
  workingHoursStart    String?
  workingHoursEnd      String?
  workingDays          String[] @default(["monday", "tuesday", "wednesday", "thursday", "friday"])
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model WorkingHours {
  id              String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  domainId        String     @unique @db.Uuid
  enabled         Boolean    @default(false)
  mondayRanges    String[]   @default([])
  mondayClosed    Boolean    @default(false)
  tuesdayRanges   String[]   @default([])
  tuesdayClosed   Boolean    @default(false)
  wednesdayRanges String[]   @default([])
  wednesdayClosed Boolean    @default(false)
  thursdayRanges  String[]   @default([])
  thursdayClosed  Boolean    @default(false)
  fridayRanges    String[]   @default([])
  fridayClosed    Boolean    @default(false)
  saturdayRanges  String[]   @default([])
  saturdayClosed  Boolean    @default(true)
  sundayRanges    String[]   @default([])
  sundayClosed    Boolean    @default(true)
  blackoutDates   DateTime[]
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  domain          Domain     @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@index([domainId])
}

model BillingAddress {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @unique @db.Uuid
  name      String
  street    String?
  city      String?
  state     String?
  country   String?
  zipCode   String?
  vatNumber String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PaymentHistory {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String   @db.Uuid
  amount                Int
  currency              String   @default("usd")
  status                String
  plan                  Plans?
  description           String?
  stripePaymentIntentId String   @unique
  stripeInvoiceId       String?
  paymentMethod         String?
  paymentBrand          String?
  receiptUrl            String?
  createdAt             DateTime @default(now())
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model KnowledgeBaseFile {
  id          String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  filename    String
  fileType    String
  filePath    String
  fileSize    Int
  status      KnowledgeBaseFileStatus @default(READY)
  errorMessage String?                @db.Text
  userId      String                  @db.Uuid
  domainId    String?                 @db.Uuid
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  Domain      Domain?                 @relation(fields: [domainId], references: [id], onDelete: Cascade)
  User        User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  chunks      KnowledgeBaseChunk[]

  @@index([userId])
  @@index([domainId])
  @@index([status])
}

model KnowledgeBaseChunk {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  content    String   @db.Text
  embedding  Unsupported("vector(1536)")
  userId     String   @db.Uuid
  domainId   String?  @db.Uuid
  fileId     String   @db.Uuid
  chunkIndex Int
  createdAt  DateTime @default(now())
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Domain     Domain?  @relation(fields: [domainId], references: [id], onDelete: Cascade)
  file       KnowledgeBaseFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([domainId])
  @@index([fileId])
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FAILED
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
  CANCELLED
}

enum Plans {
  STANDARD
  PRO
  ULTIMATE
}

enum Role {
  user
  assistant
}

enum KnowledgeBaseFileStatus {
  READY
  PROCESSING
  DISABLED
  FAILED
}
